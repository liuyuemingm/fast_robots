<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
        <meta name="description" content="" />
        <meta name="author" content="" />
        <title>Yueming Liu - Fast Robots</title>
        <link rel="icon" type="image/x-icon" href="assets/img/favicon.ico" />
        <!-- Font Awesome icons (free version)-->
        <script src="https://use.fontawesome.com/releases/v6.3.0/js/all.js" crossorigin="anonymous"></script>
        <!-- Google fonts-->
        <link href="https://fonts.googleapis.com/css?family=Saira+Extra+Condensed:500,700" rel="stylesheet" type="text/css" />
        <link href="https://fonts.googleapis.com/css?family=Muli:400,400i,800,800i" rel="stylesheet" type="text/css" />
        <!-- Core theme CSS (includes Bootstrap)-->
        <link href="css/styles.css" rel="stylesheet" />
    </head>
    <body id="page-top">
        <!-- Navigation-->
        <nav class="navbar navbar-expand-lg navbar-dark bg-primary fixed-top" id="sideNav">
            <a class="navbar-brand js-scroll-trigger" href="#page-top">
                <span class="d-block d-lg-none">Yueming Liu</span>
                <span class="d-none d-lg-block"><img class="img-fluid img-profile rounded-circle mx-auto mb-2" src="assets/img/profile.jpg" alt="..." /></span>
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button>
            <div class="collapse navbar-collapse" id="navbarResponsive">
                <ul class="navbar-nav">
                    <li class="nav-item"><a class="nav-link js-scroll-trigger" href="#About">About</a></li>
                    <li class="nav-item"><a class="nav-link js-scroll-trigger" href="#Lab 1">Lab 1</a></li>
                    <li class="nav-item"><a class="nav-link js-scroll-trigger" href="#Lab 2">Lab 2</a></li>
                    <li class="nav-item"><a class="nav-link js-scroll-trigger" href="#Lab 3">Lab 3</a></li>
                    <li class="nav-item"><a class="nav-link js-scroll-trigger" href="#Lab 4">Lab 4</a></li>
                    <li class="nav-item"><a class="nav-link js-scroll-trigger" href="#Lab 5">Lab 5</a></li>
                    <li class="nav-item"><a class="nav-link js-scroll-trigger" href="#Lab 6">Lab 6</a></li>
                </ul>
            </div>
        </nav>
        <!-- Page Content-->
        <div class="container-fluid p-0">
            <!-- About-->
            <section class="resume-section" id="About">
                <div class="resume-section-content">
                    <h1 class="mb-0">
                        Yueming
                        <span class="text-primary">Liu</span>
                    </h1>
                    <div class="subheading mb-5">
                        MAE 5190: Fast Robots
                        
                    </div>
                    <p class="lead mb-5">I am an MEng Student in Mechanical Engineering at Cornell University, 
                        please check out my main website <a href="https://yueming-liu.web.app/">here</a>! </p>
                
                </div>
            </section>
            <hr class="m-0" />
            <!-- Lab 1-->
            <section class="resume-section" id="Lab 1">
                <div class="resume-section-content">
                    <h2 class="mb-0">Lab 1 <span class="text-primary">The Artemis board and Bluetooth</span> </h2>
                    <p class="mb-5">The goal of this lab is to set up the Arduino IDE for the Artemis board, and connect the board to the laptop with Bluetooth and Jupyter Lab notebook.</p>
                        
                    <div class="d-flex flex-column flex-md-row justify-content-between mb-5">
                        <div class="flex-grow-1">
                            <h3 class="mb-3">Part A</h3>

                            <div class="mb-5">
                                <div class="subheading mb-0">Prelab</div>
                                <p>For the prelab, I updated my Arduino IDE to the lastest version and installed the Sparkfun Appollo3 boards manager in the IDE. </p>
                            </div>

                            <div class="mb-5">
                                <div class="subheading mb-0">Task 1: Blink</div>
                                <p>To test the basic connectivity of the board, I ran the example script File->Examples->01.Basics </p>
                                <iframe width="420" height="315"
                                    src="https://www.youtube.com/embed/op_ChMm5QYk">
                                </iframe>
                            </div>

                            <div class="mb-5">
                                <div class="subheading mb-0">Task 2: Serial Output</div>
                                <p>To test the serial monitor functionality, I set the baud rate of the board and the serial monitor to 115200 and ran the example script File->Examples->Apollo3->Example4_Serial. I was able to see the output when I reset the board. </p>
                                <iframe width="420" height="315"
                                    src="https://www.youtube.com/embed/7u9DyQK-hrk">
                                </iframe>
                            </div>

                            <div class="mb-5">
                                <div class="subheading mb-0">Task 3: Analog Read</div>
                                <p>To test temperature sensor on the boad and the analog read functionality, I ran the example script File->Examples->Apollo3->Example2_analogRead. I was able to change the temperature output (the second colomn) by touching the sensor with my fingers. </p>
                                <iframe width="420" height="315"
                                    src="https://www.youtube.com/embed/4Vi-IR_s2ds">
                                </iframe>
                            </div>

                            <div class="mb-5">
                                <div class="subheading mb-0">Task 4: Microphone Output</div>
                                <p>To test microphone on the boad, I ran the example script File->Examples->PDM->Example1_MicrophoneOutput. I played an audio clip with an increasing pitch and the board correctly outputted the increasing frequencies. </p>
                                <iframe width="420" height="315"
                                    src="https://www.youtube.com/embed/elPu62MjLh0">
                                </iframe>
                            </div>

                            <div class="mb-5">
                                <div class="subheading mb-0">Task 5: Blink at C Note</div>
                                <p>I programmed the board to blink the LED when I play a musical "C" note, and off otherwise. </p>
                                <iframe width="420" height="315"
                                    src="https://www.youtube.com/embed/T_X3ld3etUc">
                                </iframe>
                            </div>




                            <h3 class="mb-3">Part B</h3>

                            <div class="mb-5">
                                <div class="subheading mb-0">Prelab</div>
                                <p>For the prelab, I first installed venv. </p>
                                <div class="code-container"><div class="line-numbers">1</div>
                                <div class="code-content"><code class="mb-0">python3 -m pip install --user virtualenv</code></div></div>
                                <p>I created a Python virtual environement under my project directory and activated it. </p>
                                <div class="code-container"><div class="line-numbers">1<br>2</div>
                                <div class="code-content"><code class="mb-0">python3 -m venv FastRobots_ble<br>source FastRobots_ble/bin/activate</code></div></div>
                                <p>I then installed all the necessary packages. </p>
                                <div class="code-container"><div class="line-numbers">1</div>
                                <div class="code-content"><code class="mb-0">pip install numpy pyyaml colorama nest_asyncio bleak jupyterlab</code></div></div>
                                <p>After that I was able to start the Jupyter server in my project directory. </p>
                                <div class="code-container"><div class="line-numbers">1</div>
                                <div class="code-content"><code class="mb-0">Jupyter lab</code></div></div>
                            </div>

                            <div class="mb-5">
                                <div class="subheading mb-0">Configurations</div>
                                <p>In connections.yaml, I replaced the artemis_address value with the MAC address printed by my Artemis in the prelab. </p>
                                <div class="code-container"><div class="line-numbers">1</div>
                                <div class="code-content"><code class="mb-0">artemis_address: 'c0:81:85:26:a3:64'</code></div></div>
                                <p>I then generated a new UUID for my Artemis board, </p>
                                <div class="code-container"><div class="line-numbers">1<br>2</div>
                                <div class="code-content"><code class="mb-0">from uuid import uuid4<br>uuid4()</code></div></div>
                                <p>and used this UUID for my BLE_UUID_TEST_SERVICE in ble_arduino.ino and for my ble_service in connections.yaml. </p>
                                
                            </div>

                            <div class="mb-5">
                                <div class="subheading mb-0">Task 1: ECHO</div>
                                <p>For the ECHO command, the Artemis board receives a string message from the computer, augments the string, and sends it back to the computer. </p>
                                <p>On the Artemis board side: </p>
                                <div class="code-container"><div class="line-numbers">1<br>2<br>3<br>4<br>5<br>6<br>7<br>8<br>9<br>10<br>11<br>12<br>13<br>14<br>15</div>
                                <div class="code-content"><code class="mb-0">case ECHO:
    char char_arr[MAX_MSG_SIZE];

    // Extract the next value from the command string as a character array
    success = robot_cmd.get_next_value(char_arr);
    if (!success)
        return;

    tx_estring_value.clear();
    tx_estring_value.append("Robot says -> ");
    tx_estring_value.append(char_arr);
    tx_estring_value.append(" :)");
    tx_characteristic_string.writeValue(tx_estring_value.c_str());

    break;</code></div></div>
                                <p>On the Computer side: </p>
                                <div class="code-container"><div class="line-numbers">1<br>2<br>3</div>
                                <div class="code-content"><code class="mb-0">ble.send_command(CMD.ECHO, "hey")<br>s = ble.receive_string(ble.uuid['RX_STRING'])<br>print(s)</code></div></div>
                                <p>Output from the Jupyter notebook: </p>
                                <div class="code-container"><div class="line-numbers">1</div>
                                <div class="code-content"><code class="mb-0">Robot says -> hey :)</code></div></div>
                                
                            </div>

                            <div class="mb-5">
                                <div class="subheading mb-0">Task 2: SEND_THREE_FLOATS</div>
                                <p>The SEND_THREE_FLOATS command sends three floats to the Artemis board, and the board extracts and prints the three float values. </p>
                                <p>On the Artemis board side: </p>
                                <div class="code-container"><div class="line-numbers">1<br>2<br>3<br>4<br>5<br>6<br>7<br>8<br>9<br>10<br>11<br>12<br>13<br>14<br>15<br>16<br>17<br>18<br>19<br>20<br>21<br>22<br>23<br>24<br>25</div>
                                <div class="code-content"><code class="mb-0">case SEND_THREE_FLOATS:
    float float1, float2, float3;

    // Extract the next value from the command string as an integer
    success = robot_cmd.get_next_value(float1);
    if (!success)
        return;

    // Extract the next value from the command string as an integer
    success = robot_cmd.get_next_value(float2);
    if (!success)
        return;

    success = robot_cmd.get_next_value(float3);
    if (!success)
        return;

    Serial.print("Three floats: ");
    Serial.print(float1);
    Serial.print(", ");
    Serial.print(float2);
    Serial.print(", ");
    Serial.println(float3);

    break;</code></div></div>
                                <p>On the Computer side: </p>
                                <div class="code-container"><div class="line-numbers">1</div>
                                <div class="code-content"><code class="mb-0">ble.send_command(CMD.SEND_THREE_FLOATS, "1.0| 2.0| 3.0")</code></div></div>
                                <p>Output from the Serial Monitor: </p>
                                <div class="code-container"><div class="line-numbers">1</div>
                                <div class="code-content"><code class="mb-0">Three floats: 1.00, 2.00, 3.00</code></div></div>
                            </div>

                            <div class="mb-5">
                                <div class="subheading mb-0">Task 3: GET_TIME_MILLIS</div>
                                <p>The GET_TIME_MILLIS command makes the robot reply with a string with the value of current time in milliseconds.</p>
                                <p>On the Artemis board side: </p>
                                <div class="code-container"><div class="line-numbers">1<br>2<br>3<br>4<br>5<br>6<br>7<br>8<br>9</div>
                                <div class="code-content"><code class="mb-0">case GET_TIME_MILLIS:{
    unsigned long timeMillis = millis();
    char buffer[20];
    itoa(timeMillis, buffer, 10);
    tx_estring_value.clear();
    tx_estring_value.append(buffer);
    tx_characteristic_string.writeValue(tx_estring_value.c_str());
}break;</code></div></div>
                                <p>On the Computer side: </p>
                                <div class="code-container"><div class="line-numbers">1<br>2<br>3</div>
                                <div class="code-content"><code class="mb-0">ble.send_command(CMD.GET_TIME_MILLIS, "")
s = ble.receive_string(ble.uuid['RX_STRING'])
print(s)</code></div></div>
                                <p>Output from the Jupyter notebook: </p>
                                <div class="code-container"><div class="line-numbers">1</div>
                                <div class="code-content"><code class="mb-0">43749</code></div></div>
                            
                            </div>

                            <div class="mb-5">
                                <div class="subheading mb-0">Task 4: Notification Handling</div>
                                <p>When we are unsure about when we receive data from the Artemis board, it is important to set up a notification handler instead of directly calling ble.receive_string(ble.uuid['RX_STRING']). </p>
                                <p>Nothing to be done on the Artemis board side. On the Computer side: </p>
                                <div class="code-container"><div class="line-numbers">1<br>2<br>3<br>4<br>5</div>
                                <div class="code-content"><code class="mb-0">def notification_handler(uuid, notification):
    s = ble.bytearray_to_string(notification)
    print("Time: " + s)
ble.start_notify(ble.uuid['RX_STRING'], notification_handler)
ble.send_command(CMD.GET_TIME_MILLIS, "")</code></div></div>
                                <p>Output from the Jupyter notebook: </p>
                                <div class="code-container"><div class="line-numbers">1</div>
                                <div class="code-content"><code class="mb-0">Time: 43959</code></div></div>
                            </div>



                            <div class="mb-5">
                                <div class="subheading mb-0">Task 5: GET_TIME_LOOP</div>
                                <p>Similar to GET_TIME_MILLIS command, GET_TIME_LOOP gets the current time in milliseconds and sends it to the laptop to be received and processed by the notification handler.</p>
                                <p>On the Artemis board side: </p>
                                <div class="code-container"><div class="line-numbers">1<br>2<br>3<br>4<br>5<br>6<br>7<br>8<br>9<br>10<br>11<br>12<br>13</div>
                                <div class="code-content"><code class="mb-0">case GET_TIME_LOOP:{
    int num_notify = 30;
    for (int i = 0; i < num_notify; i++) {
        unsigned long timeMillis = millis();
        char buffer[20];
        itoa(timeMillis, buffer, 10);
        tx_estring_value.clear();
        tx_estring_value.append(buffer);
        tx_characteristic_string.writeValue(tx_estring_value.c_str());
        Serial.println("Sent current time.");
    }  
}break;</code></div></div>
                                <p>On the Computer side: </p>
                                <div class="code-container"><div class="line-numbers">1<br>2<br>3<br>4<br>5<br>6<br>7<br>8</div>
                                <div class="code-content"><code class="mb-0">time = []
def notification_handler_loop(uuid, notification):
    s = ble.bytearray_to_string(notification)
    time.append(s)

ble.start_notify(ble.uuid['RX_STRING'], notification_handler_loop)
ble.send_command(CMD.GET_TIME_LOOP, "")
print(time)</code></div></div>
                                <p>Output from the Jupyter notebook: </p>
                                <div class="code-container"><div class="line-numbers">1</div>
                                <div class="code-content"><code class="mb-0">['165447', '165449', '165450', '165452', '165481']</code></div></div>
                                <p>The board sent 5 messages (4 bytes each) in 165481ms - 165447ms = 34ms, so the effective data transfer rate is 5*4/34*1000 = 588 bytes per second. </p>
                            </div>



                            <div class="mb-5">
                                <div class="subheading mb-0">Task 6: SEND_TIME_DATA</div>
                                <p>The SEND_TIME_DATA command is similar to GET_TIME_LOOP, but stores the times in an array before start sending them. </p>
                                <p>On the Artemis board side, first define numTimeStamps and the array timeStamps, and then: </p>
                                <div class="code-container"><div class="line-numbers">1<br>2<br>3<br>4<br>5<br>6<br>7<br>8<br>9<br>10<br>11<br>12<br>13<br>14<br>15<br>16</div>
                                <div class="code-content"><code class="mb-0">case SEND_TIME_DATA:{
int c = 0;
    while(true){
    timeStamps[c] = (int) millis();
    c++;
        if(c > numTimeStamps-1){
            break;
        }
    }

    for (int i = 0; i < numTimeStamps; i++) {
        tx_estring_value.clear();
        tx_estring_value.append(timeStamps[i]);
        tx_characteristic_string.writeValue(tx_estring_value.c_str());
    }  
}break;</code></div></div>
                                <p>On the Computer side, similar to last step but change the command to: </p>
                                <div class="code-container"><div class="line-numbers">1</div>
                                <div class="code-content"><code class="mb-0">ble.send_command(CMD.SEND_TIME_DATA, "")</code></div></div>
                                <p>Output from the Jupyter notebook was an array of size numTimeStamps. </p>
                            </div>

                            <div class="mb-5">
                                <div class="subheading mb-0">Task 7: GET_TEMP_READINGS</div>
                                <p>In addition to getting the time stamp, read temperature at each time stamp. </p>
                                <p>On the Artemis board side: </p>
                                <div class="code-container"><div class="line-numbers">1<br>2<br>3<br>4<br>5<br>6<br>7<br>8<br>9<br>10<br>11<br>12<br>13<br>14<br>15<br>16<br>17<br>18<br>19</div>
                                <div class="code-content"><code class="mb-0">case GET_TEMP_READINGS:{
int c = 0;
    while(true){
    timeStamps[c] = (int) millis();
    tempReadings[c] = getTempDegF();
    c++;
        if(c > numTimeStamps-1){
            break;
        }
    }
    for (int i = 0; i < numTimeStamps; i++) {
        tx_estring_value.clear();
        tx_estring_value.append("Time: ");
        tx_estring_value.append(timeStamps[i]);
        tx_estring_value.append(", Temp (F): ");
        tx_estring_value.append(tempReadings[i]);
        tx_characteristic_string.writeValue(tx_estring_value.c_str());
    }  
}break;</code></div></div>
                                <p>On the Computer side, similar to last step but change the command to: </p>
                                <div class="code-container"><div class="line-numbers">1</div>
                                <div class="code-content"><code class="mb-0">ble.send_command(CMD.GET_TEMP_READINGS, "")</code></div></div>
                                <p>Output from the Jupyter notebook was an array of size numTimeStamps with the time stamps and the corresponding temperature readings. </p>
                            </div>


                            <div class="mb-5">
                                <div class="subheading mb-0">Task 8: Methods Comparison</div>
                                <p>The first method sends the data live, which makes debuggin quick and easy with the data streaming. 
                                    We are not worried about running out of space on the Artemis board as the data is not being stored there. 
                                    The rate in which it records and sends data, however, is limited because it needs alternate between these two tasks. 
                                    Some data might also get lost in this process. </p>

                                <p>The second method stores all the data on the board and transmits it at some later time. 
                                    It is significantly faster than the first one since it does not need to transmit data while also recording it. 
                                    However, we need to be considerate about the storage space on board. The Artemis board has 384 kB of RAM. 
                                    If each datapoint is 4 bytes, then it runs out of space after 96000 datapoints. </p>
                            </div>


                            <div class="mb-5">
                                <div class="subheading mb-0">Task 9: Effective Data Rate and Overhead </div>
                                <p>We are insterested in the data rate with respect to the size of the packets. 
                                    In order to find this relation, we can command the board to send a series of packets of different sizes to the computer, 
                                    and record the difference between the send time and receive time of each packete. Here the ECHO command returns exactly the message sent:   </p>
                                <div class="code-container"><div class="line-numbers">1<br>2<br>3<br>4<br>5<br>6<br>7<br>8<br>9<br>10<br>11<br>12<br>13<br>14<br>15<br>16</div>
                                <div class="code-content"><code class="mb-0">packet = []
time_send = []
time_receive = []
data_size = []
def notification_handler_packet(uuid, notification):
    packet.append(ble.bytearray_to_string(notification))

ble.start_notify(ble.uuid['RX_STRING'], notification_handler_packet)
for bytes in range(5, 125, 5):
    data_size.append(bytes)
    packet = []
    time_send.append(time.time())
    ble.send_command(CMD.ECHO, "a"*bytes)
    
    while not packet:
        time_receive.append(time.time())</code></div></div>
                                <p>Output from the Jupyter notebook is shown below. The datarate increases 
                                    linearly with respect to the packet size, indicating that short packets 
                                    introduce significant overhead, whereas big packets helps with amortization. </p>
                                    <img class="mb-2" width="420" src="assets/img/lab1_9.png" alt="..." />
                            </div>


                            <div class="mb-5">
                                <div class="subheading mb-0">Task 10: Reliability </div>
                                <p>After experimenting with sending a large number of messages at a high rate from the Artemis board to the computer, 
                                    the communication appears to be reasonably reliable, and all the data published from the board was received by the computer.  </p>
                                </div>

                            <div class="mb-5">
                                <div class="subheading mb-0">Discussion </div>
                                <p>In this lab I learned about the BLE communication scheme and its restrictions, which is going to be very useful in the future labs when we need to send data from the robot to the computer. 
                                    I was initially struggling with understanding the BLE code structure but was able to make good progress after reading the documentation. 
                                </div>
                            
                        </div>
                    </div>
                </div>
            </section>
            <hr class="m-0" />



            <!-- Lab 2-->
            <section class="resume-section" id="Lab 2">
                <div class="resume-section-content">
                    <h2 class="mb-0">Lab 2 <span class="text-primary">IMU</span></h2>
                    <p class="mb-5">The goal of this lab is to characterize and test the  Inertial Measurement Unit (IMU). </p>
                    
                    <div class="mb-5">
                        <div class="subheading mb-0">Task 1: IMU Setup</div>
                        <p>I installed the necessary library for the ICM 20948 Inertial Measurement Unit (IMU), 
                            connected the IMU to the Artemis board with a QWIIC connector as shown below, and ran the first example in the ICM-20948 Library which prints the IMU measurements.
                            The AD0_VAL is the value of the last bit of the I2C address. Since my ADR jumper is open, the AD0_VAL should be default to 1. </p>
                        <img class="mb-2" width="420" src="assets/img/lab2_1.jpeg" alt="..." />
                        <p>I included start-up blink in the example code as shown in the video. The accelerometer readings do not change significantly when I rotate the sensor around the z-axis slowly; 
                            It changes when I accelerate, flip, or rotate the sensor around a different axis. The Gyroscope readings do not change significantly when I linearly accelerate or slowly rotate the sensor. It changes
                            when I flip or rotate the sensor quickly.  </p>
                        <iframe width="420" height="315"
                            src="https://www.youtube.com/embed/-sq594vBxdk">
                        </iframe>
                    </div>


                    <div class="mb-5">
                        <div class="subheading mb-0">Task 2: Accelerometer</div>
                        <p>I used the equations from class to convert the accelerometer data into pitch and roll. </p>
                        <div class="code-container"><div class="line-numbers">1<br>2</div>
                        <div class="code-content"><code class="mb-0">pitch_a = atan2(myICM.accY(),myICM.accZ())*180/M_PI;<br>roll_a  = atan2(myICM.accX(),myICM.accZ())*180/M_PI;</code></div></div>
                        <p>The picture below shows the output from the Serial Monitor at {-90, 0, 90} degrees pitch and roll. 
                            The accelerometer is fairly accurate, with error bound within +/-0.5 degree. Therefore I do not think a two-point calibration is needed for this sensor: </p>
                        <img class="mb-2" width="840" src="assets/img/lab2_2.JPG" alt="..." />
                        <p>Once the IMU sensors is mounted on the car, it will receive a lot of noise from the environement. In order to filter out some of the noises, we need to first apply Fourier Transform to 
                            the raw data, and from the Fourier Transform we can find a cutoff frequency that separate the noise from the useful information. We can then implement a low pass filter (LPF) with this cutoff frequency to clean up the raw data. 
                            The following plots show the raw data from some test runs and the Fourier Transforms of the pitch and roll readings from the accelerometer: 
                        </p>
                        <img class="mb-2" height="315" src="assets/img/lab2_3.png" alt="..." />
                        <img class="mb-2" height="315" src="assets/img/lab2_4.png" alt="..." />
                        <img class="mb-2" height="315" src="assets/img/lab2_5.png" alt="..." />
                        <img class="mb-2" height="315" src="assets/img/lab2_6.png" alt="..." />
                        <p>As shown in the FFT plots above, there is a peak of noise at around 50Hz for both pitch and roll data, 
                            and 10Hz appears to be a good cut-off frequency in this case, although this number is subject 
                            to change after the sensor is mounted on the robot. The implementation of the low pass filter and the results are shown below. 
                        After applying the filter, the data preserves the overall trend but is much less noisy:</p>
                        <div class="code-container"><div class="line-numbers">1<br>2<br>3<br>4<br>5<br>6<br>7<br>8<br>9</div>
                        <div class="code-content"><code class="mb-0">fc = 10
T = (time_a[-1] - time_a[0])/(len(time_a)-1)
RC = 1 / (2 * np.pi * fc)
alpha = T / (T + RC)
pitch_a_LPF = [0]*len(pitch_a)

for n in range(1, len(pitch_a)):
    pitch_a_LPF[n] = alpha*pitch_a[n] + (1-alpha)*pitch_a_LPF[n-1]
    pitch_a_LPF[n-1] = pitch_a_LPF[n]</code></div></div>
                        <img class="mb-2" height="315" src="assets/img/lab2_7.png" alt="..." />
                        <img class="mb-2" height="315" src="assets/img/lab2_8.png" alt="..." />
                        </div>
                        



                    <div class="mb-5">
                        <div class="subheading mb-0">Task 3: Gyroscope</div>
                        <p>I used the equations from class to convert the gyroscope data into pitch, roll, and yaw by estimating the angles using angle derivatives from the myICM.gyrX(), myICM.gyrY(), and myICM.gyrZ() output: </p>
                        <div class="code-container"><div class="line-numbers">1<br>2<br>3</div>
                        <div class="code-content"><code class="mb-0">pitch_g = pitch_g + myICM.gyrX()*dt;<br>roll_g = roll_g + myICM.gyrY()*dt;<br>yaw_g = yaw_g + myICM.gyrZ()*dt;</code></div></div>
                        <p>As shown below, for both the pitch and roll data, the overall trend from the accelerometer 
                            and the gyroscope match closely. However, data from gyroscope appears to have a increasing 
                            drift, despite being more accurate at the beginning and less noisy overall. In order to 
                            account for the drift in the gyroscope and the noise and inaccuracy in the accelerometer, 
                            I applied a complementary filter with alpha = 0.01: </p>
                        <div class="code-container"><div class="line-numbers">1<br>2</div>
                        <div class="code-content"><code class="mb-0">pitch = (pitch+myICM.gyrX()*dt)*(1-alpha_cf) + pitch_a*alpha_cf;<br>roll = (roll+myICM.gyrY()*dt)*(1-alpha_cf) + roll_a*alpha_cf;</code></div></div>
                        <img class="mb-2" width="420" src="assets/img/lab2_9.png" alt="..." />
                        <img class="mb-2" width="420" src="assets/img/lab2_10.png" alt="..." />
                        <img class="mb-2" width="420" src="assets/img/lab2_11.png" alt="..." />
                        <p>For the plot below, I lowered the sampling frequency, and the angle estimation appears to be a lot worse eventhough the overall trend still match up between the accelerometer and the gyroscope. </p>
                        <img class="mb-2" width="420" src="assets/img/lab2_12.png" alt="..." />
                        
                        
                        
                            
                    </div>

                    <div class="mb-5">
                        <div class="subheading mb-0">Task 4: Sample Data</div>
                        <p>I sped up the execution of my loop for the Artemis board by removing all the delays 
                            and Serial print statements. </p>
                        <div class="code-container"><div class="line-numbers">1<br>2<br>3<br>4<br>5<br>6<br>7<br>8<br>9<br>10<br>11<br>12<br>13<br>14<br>15<br>16<br>17<br>18<br>19<br>20<br>21<br>22<br>23<br>24<br>25</div>
                        <div class="code-content"><code class="mb-0">case GET_IMU_ACC_READINGS:{
int c = 0;
    while(true){
        if (myICM.dataReady())
        {
            timeStamps[c] = (int) millis();
            myICM.getAGMT(); 
            pitch_a_data[c] = get_pitch_a();
            roll_a_data[c] = get_roll_a();
        }
        c++;
        if(c > numTimeStamps-1){
            break;
        }
    }
    for (int i = 0; i < numTimeStamps; i++) {
        tx_estring_value.clear();
        tx_estring_value.append(timeStamps[i]);
        tx_estring_value.append("|");
        tx_estring_value.append(pitch_a_data[i]);
        tx_estring_value.append("|");
        tx_estring_value.append(roll_a_data[i]);
        tx_characteristic_string.writeValue(tx_estring_value.c_str());
    }  
}break;</code></div></div>
                        <p>As shown below, the sampled values are stored in the form of
                            ‘time_stamp | pitch_a | roll_a | pitch_g_raw | roll_g_raw | yaw_g_raw', 
                               and I was able to collect 1000 data points in 5.567s, so the sampling rate is 179 data points/second. 
                               The main loop on my Artemis board does not run faster than the IMU produces new values.</p>
                        <img class="mb-2" width="840" src="assets/img/lab2_13.png" alt="..." />

                        <p>It worked for me to have separate arrays for storing accelerometer and gyroscope data as sometimes we 
                            need to access them separately for calculations. However, I did combine them together with the timestamp 
                            into one string for data transmission. This allows me to send over information of different data types 
                            (int and float) at once, reducing the overhead for data transmission. </p>
                        <p>The Artemis board has 384 kB of RAM, and each datapoint (1x int and 5x float) is 24 Bytes, 
                            meaning that it can take at most 16,000 data points. With a rate of 179 data points/second, 
                            this memory corresponds to 89 seconds of IMU data.</p>
                        <p>All plots in Task 3. Gyroscope (the second above) demonstrates that my board can capture at least 5s worth of IMU data 
                            and send it over Bluetooth to the computer.</p>
                    </div>


                    <div class="mb-5">
                        <div class="subheading mb-0">Task 5: Record a Stunt</div>
                        <p>Here is the car doing a backflip! The easiest way to do a backflip is to reverse direction rapidly or have the robot bump into an obstacle. </p>
                        
                            <iframe width="420" height="315"
                            src="https://www.youtube.com/embed/Ibk4pZxtz9s">
                        </iframe>
                    </div>

                    <div class="mb-5">
                        <div class="subheading mb-0">Discussion</div>
                        <p>It is important to use the correct filter for different data, and be mindful about how the data is stored and transmitted as we incorporate more sensors. </p>
                        
                    </div>

                    
                </div>
            </section>
            <hr class="m-0" />
            <!-- Lab 3-->
            <section class="resume-section" id="Lab 3">
                <div class="resume-section-content">
                    <h2 class="mb-5">Lab 3</h2>
                    
                </div>
            </section>
            <!-- Lab 4-->
            <section class="resume-section" id="Lab 4">
                <div class="resume-section-content">
                    <h2 class="mb-5">Lab 4</h2>
                    
                </div>
            </section>
            <!-- Lab 5-->
            <section class="resume-section" id="Lab 5">
                <div class="resume-section-content">
                    <h2 class="mb-5">Lab 5</h2>
                    
                </div>
            </section>
            <!-- Lab 6-->
            <section class="resume-section" id="Lab 6">
                <div class="resume-section-content">
                    <h2 class="mb-5">Lab 6</h2>
                    
                </div>
            </section>
    </body>
</html>
